<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Berklast AI</title>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg1:#070A12;
      --bg2:#0B1030;
      --glass: rgba(255,255,255,.08);
      --glass2: rgba(255,255,255,.12);
      --text:#EAF0FF;
      --muted: rgba(234,240,255,.65);
      --line: rgba(255,255,255,.10);
      --accent:#7C5CFF;
      --accent2:#22D3EE;
      --danger:#FF4D6D;
      --ok:#22C55E;
      --shadow: 0 20px 60px rgba(0,0,0,.55);
      --r: 18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:Inter,system-ui,Segoe UI,Arial;
      color:var(--text);
      overflow:hidden;
      background: radial-gradient(1200px 700px at 20% 10%, rgba(124,92,255,.25), transparent 55%),
                  radial-gradient(900px 600px at 80% 30%, rgba(34,211,238,.18), transparent 60%),
                  radial-gradient(900px 600px at 50% 90%, rgba(124,92,255,.12), transparent 60%),
                  linear-gradient(120deg, var(--bg1), var(--bg2));
    }

    /* animated background glow */
    .glow{
      position:fixed; inset:-20%;
      background:
        radial-gradient(circle at 20% 20%, rgba(124,92,255,.35), transparent 40%),
        radial-gradient(circle at 80% 40%, rgba(34,211,238,.30), transparent 45%),
        radial-gradient(circle at 60% 80%, rgba(124,92,255,.20), transparent 45%);
      filter: blur(50px);
      animation: drift 14s ease-in-out infinite alternate;
      opacity:.8;
      pointer-events:none;
    }
    @keyframes drift{
      0%{transform:translate3d(-2%, -1%, 0) scale(1)}
      100%{transform:translate3d(2%, 1%, 0) scale(1.05)}
    }

    canvas#particles{position:fixed; inset:0; pointer-events:none; opacity:.55}

    .wrap{
      position:relative;
      height:100%;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
    }

    .app{
      width:min(980px, 100%);
      height:min(740px, 100%);
      display:flex;
      flex-direction:column;
      border:1px solid var(--line);
      border-radius:24px;
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
      box-shadow:var(--shadow);
      backdrop-filter: blur(14px);
      overflow:hidden;
    }

    .top{
      display:flex;
      gap:12px;
      align-items:center;
      justify-content:space-between;
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.02));
    }

    .brand{
      display:flex; gap:10px; align-items:center;
    }
    .logo{
      width:38px; height:38px; border-radius:14px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,.35), transparent 45%),
                  linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 10px 30px rgba(124,92,255,.25);
      position:relative;
    }
    .logo:after{
      content:"";
      position:absolute; inset:1px;
      border-radius:13px;
      border:1px solid rgba(255,255,255,.18);
    }
    .title{
      line-height:1.05;
    }
    .title b{font-weight:800; letter-spacing:.2px}
    .title div{font-size:12px; color:var(--muted); margin-top:2px}

    .actions{
      display:flex; gap:10px; align-items:center;
    }

    .pill{
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      display:flex; gap:8px; align-items:center;
      user-select:none;
    }

    .btn{
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      color:var(--text);
      padding:10px 12px;
      border-radius:12px;
      cursor:pointer;
      transition:.2s transform, .2s background, .2s border;
      font-weight:600;
    }
    .btn:hover{transform:translateY(-1px); background:rgba(255,255,255,.08)}
    .btn:active{transform:translateY(0px)}
    .btn.danger{border-color:rgba(255,77,109,.35)}
    .btn.danger:hover{background:rgba(255,77,109,.12)}

    .chat{
      flex:1;
      overflow:auto;
      padding:18px 14px 10px;
      scroll-behavior:smooth;
    }

    .chips{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      padding:0 2px 14px;
    }
    .chip{
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--muted);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-size:12px;
      transition:.15s transform, .15s background;
    }
    .chip:hover{transform:translateY(-1px); background:rgba(255,255,255,.08)}

    .msg{
      display:flex;
      gap:10px;
      margin:10px 0;
      animation: pop .18s ease-out;
    }
    @keyframes pop{
      from{transform:translateY(6px); opacity:.0}
      to{transform:translateY(0); opacity:1}
    }

    .avatar{
      width:34px; height:34px; border-radius:14px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.08);
      display:flex; align-items:center; justify-content:center;
      flex:0 0 auto;
      box-shadow: 0 10px 25px rgba(0,0,0,.25);
    }
    .avatar.user{background:linear-gradient(135deg, rgba(124,92,255,.35), rgba(34,211,238,.20))}
    .avatar.ai{background:linear-gradient(135deg, rgba(34,211,238,.25), rgba(124,92,255,.20))}

    .bubble{
      max-width:min(740px, 100%);
      padding:12px 14px;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      color:var(--text);
      line-height:1.35;
      white-space:pre-wrap;
      word-wrap:break-word;
      box-shadow: 0 12px 30px rgba(0,0,0,.25);
    }
    .bubble.user{
      background:linear-gradient(180deg, rgba(124,92,255,.18), rgba(0,0,0,.18));
    }
    .bubble.ai{
      background:linear-gradient(180deg, rgba(34,211,238,.12), rgba(0,0,0,.18));
    }

    .meta{
      font-size:11px;
      color:var(--muted);
      margin-top:6px;
      display:flex;
      gap:10px;
      align-items:center;
    }

    .typing{
      display:inline-flex;
      gap:6px;
      align-items:center;
      padding:10px 12px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      color:var(--muted);
      font-size:12px;
    }
    .dot{
      width:6px; height:6px; border-radius:999px;
      background:rgba(234,240,255,.55);
      animation: b 1s infinite;
    }
    .dot:nth-child(2){animation-delay:.12s}
    .dot:nth-child(3){animation-delay:.24s}
    @keyframes b{
      0%,100%{transform:translateY(0); opacity:.45}
      50%{transform:translateY(-4px); opacity:1}
    }

    .composer{
      padding:12px;
      border-top:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.02), rgba(255,255,255,.07));
    }
    .row{
      display:flex; gap:10px; align-items:flex-end;
    }
    textarea{
      flex:1;
      resize:none;
      border-radius:16px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      color:var(--text);
      padding:12px 12px;
      outline:none;
      min-height:48px;
      max-height:160px;
      line-height:1.25;
      font-size:14px;
    }
    textarea::placeholder{color:rgba(234,240,255,.45)}
    .send{
      padding:12px 14px;
      border-radius:16px;
      border:1px solid rgba(124,92,255,.35);
      background:linear-gradient(135deg, rgba(124,92,255,.45), rgba(34,211,238,.22));
      font-weight:800;
    }
    .send:hover{background:linear-gradient(135deg, rgba(124,92,255,.55), rgba(34,211,238,.28))}

    .foot{
      display:flex;
      justify-content:space-between;
      gap:10px;
      margin-top:10px;
      color:var(--muted);
      font-size:12px;
      padding:0 4px;
    }
    .status.ok{color:rgba(34,197,94,.9)}
    .status.bad{color:rgba(255,77,109,.95)}

    @media (max-width: 640px){
      .pill{display:none}
      .bubble{max-width:100%}
      .app{border-radius:18px}
    }
  </style>
</head>

<body>
  <div class="glow"></div>
  <canvas id="particles"></canvas>

  <div class="wrap">
    <div class="app">
      <div class="top">
        <div class="brand">
          <div class="logo"></div>
          <div class="title">
            <b>Berklast AI</b>
            <div>GitHub Pages UI • Hugging Face Space AI</div>
          </div>
        </div>

        <div class="actions">
          <div class="pill" id="pill">Bağlantı: <span id="conn" class="status">Kontrol...</span></div>
          <button class="btn danger" id="clearBtn">Sıfırla</button>
        </div>
      </div>

      <div class="chat" id="chat">
        <div class="chips" id="chips">
          <div class="chip">Roblox’ta 3 kişiyle oynanan oyun için round sistemi kur</div>
          <div class="chip">Lua’da performans optimizasyonu: mesafeye göre yükleme</div>
          <div class="chip">Bana bir GUI tasarımı öner (modern + animasyonlu)</div>
          <div class="chip">Bu hatayı analiz et: “attempt to index nil”</div>
        </div>
      </div>

      <div class="composer">
        <div class="row">
          <textarea id="input" placeholder="Mesaj yaz… (Enter: gönder, Shift+Enter: alt satır)"></textarea>
          <button class="btn send" id="sendBtn">Gönder</button>
        </div>
        <div class="foot">
          <div>İpucu: <b>/clear</b> yazarak sohbeti temizle</div>
          <div id="smallStatus" class="status">Hazır</div>
        </div>
      </div>
    </div>
  </div>

<script>
/* =========================
   AYARLAR (BURAYI DÜZENLE)
========================= */
const SPACE_URL = "https://USERNAME-SPACENAME.hf.space"; // <-- BUNU DEĞİŞTİR
const API_NAME  = "chat"; // Space içinde api_name="chat" yazdık

/* ========================= */
const chatEl = document.getElementById("chat");
const inputEl = document.getElementById("input");
const sendBtn = document.getElementById("sendBtn");
const clearBtn = document.getElementById("clearBtn");
const connEl = document.getElementById("conn");
const smallStatus = document.getElementById("smallStatus");
const chips = document.getElementById("chips");

const LS_KEY = "berklast_ai_history_v1";
const SESSION_KEY = "berklast_ai_sessionhash_v1";

let sessionHash = localStorage.getItem(SESSION_KEY);
if (!sessionHash) {
  sessionHash = Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2);
  localStorage.setItem(SESSION_KEY, sessionHash);
}

let history = loadHistory(); // [{role:"user"/"assistant", content:"..."}]

function saveHistory(){
  localStorage.setItem(LS_KEY, JSON.stringify(history.slice(-30)));
}
function loadHistory(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw) return [];
    return JSON.parse(raw) || [];
  }catch{ return []; }
}

function toTupleHistory(hist){
  // [{role,content}] -> [[user,assistant],...]
  const pairs = [];
  let lastUser = null;
  for (const m of hist){
    if (m.role === "user") lastUser = m.content;
    else if (m.role === "assistant" && lastUser !== null){
      pairs.push([lastUser, m.content]);
      lastUser = null;
    }
  }
  return pairs.slice(-12);
}

function scrollDown(){
  chatEl.scrollTop = chatEl.scrollHeight;
}

function el(tag, cls){
  const x = document.createElement(tag);
  if (cls) x.className = cls;
  return x;
}

function addMessage(role, text){
  const row = el("div","msg");
  const av = el("div","avatar " + (role === "user" ? "user":"ai"));
  av.textContent = role === "user" ? "B" : "AI";

  const bubble = el("div","bubble " + (role === "user" ? "user":"ai"));
  bubble.textContent = text;

  row.appendChild(av);
  row.appendChild(bubble);
  chatEl.appendChild(row);

  scrollDown();
  return bubble;
}

function setConn(ok, txt){
  connEl.textContent = txt;
  connEl.className = "status " + (ok ? "ok":"bad");
}

function setSmall(txt, ok){
  smallStatus.textContent = txt;
  smallStatus.className = "status " + (ok ? "ok":"bad");
}

function showTyping(){
  const row = el("div","msg");
  const av = el("div","avatar ai"); av.textContent="AI";
  const t = el("div","typing");
  t.innerHTML = `Düşünüyor <span class="dot"></span><span class="dot"></span><span class="dot"></span>`;
  row.appendChild(av);
  row.appendChild(t);
  row.id = "typingRow";
  chatEl.appendChild(row);
  scrollDown();
}
function hideTyping(){
  const x = document.getElementById("typingRow");
  if (x) x.remove();
}

function renderSaved(){
  if (history.length){
    chips.style.display = "none";
    for (const m of history){
      addMessage(m.role, m.content);
    }
  }
}
renderSaved();

chips.addEventListener("click",(e)=>{
  const chip = e.target.closest(".chip");
  if(!chip) return;
  inputEl.value = chip.textContent.trim();
  inputEl.focus();
});

/* =========================
   GRADIO CALL (POST + GET)
   Gradio: POST /call/{api} -> {event_id}
          GET  /call/{api}/{event_id} -> SSE event stream
========================= */
async function gradioCall(message, tupleHistory){
  // 1) POST
  const postUrl = `${SPACE_URL}/call/${API_NAME}`;
  const r1 = await fetch(postUrl, {
    method:"POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify({
      data: [message, tupleHistory],
      session_hash: sessionHash
    })
  });

  if(!r1.ok){
    const t = await r1.text().catch(()=> "");
    throw new Error(`POST hata: ${r1.status} ${t.slice(0,120)}`);
  }

  const j = await r1.json();
  const eventId = j.event_id;
  if(!eventId) throw new Error("event_id gelmedi (Space API adını kontrol et)");

  // 2) GET stream
  const getUrl = `${SPACE_URL}/call/${API_NAME}/${eventId}`;
  const r2 = await fetch(getUrl, { method:"GET" });
  if(!r2.ok) throw new Error(`GET hata: ${r2.status}`);

  const reader = r2.body.getReader();
  const dec = new TextDecoder("utf-8");
  let buf = "";

  let finalText = "";
  while(true){
    const {value, done} = await reader.read();
    if(done) break;
    buf += dec.decode(value, {stream:true});

    // SSE blocks separated by double newline
    const parts = buf.split("\n\n");
    buf = parts.pop() || "";

    for (const block of parts){
      const lines = block.split("\n").map(s=>s.trim()).filter(Boolean);
      let ev = "";
      let dataLine = "";
      for (const ln of lines){
        if(ln.startsWith("event:")) ev = ln.slice(6).trim();
        if(ln.startsWith("data:")) dataLine = ln.slice(5).trim();
      }
      if(!dataLine) continue;

      let data;
      try{ data = JSON.parse(dataLine); } catch { data = dataLine; }

      const txt = extractText(data);
      if (txt !== null){
        finalText = txt;
      }

      if(ev === "complete") return finalText;
      if(ev === "error") throw new Error("Space error");
    }
  }
  return finalText || "(Cevap alınamadı)";
}

function extractText(data){
  // data genelde ["text"] veya chat'te [[[u,a],[u,a]]] gibi gelebilir
  if (typeof data === "string") return data;
  if (!Array.isArray(data)) return null;

  // ["Bonjour..."]
  if (data.length === 1 && typeof data[0] === "string") return data[0];

  // [[["u","a"],["u","a"]]]  -> son asistan
  if (data.length === 1 && Array.isArray(data[0])) {
    const h = data[0];
    if (Array.isArray(h) && h.length) {
      const last = h[h.length - 1];
      if (Array.isArray(last) && last.length >= 2) return String(last[1] ?? "");
    }
  }
  return null;
}

/* ========================= */
async function ping(){
  try{
    // küçük bir deneme çağrısı yapmadan bağlantıyı sadece URL ile kontrol edelim:
    // View API varsa genelde Space ayakta.
    const r = await fetch(`${SPACE_URL}/`, {method:"GET"});
    setConn(r.ok, r.ok ? "Açık" : "Kapalı");
  }catch{
    setConn(false, "Kapalı");
  }
}
ping();

async function send(){
  const text = inputEl.value.trim();
  if(!text) return;

  if (text === "/clear"){
    doClear();
    inputEl.value = "";
    return;
  }

  chips.style.display = "none";

  inputEl.value = "";
  addMessage("user", text);
  history.push({role:"user", content:text});
  saveHistory();

  showTyping();
  setSmall("Cevap bekleniyor…", true);

  try{
    const tuples = toTupleHistory(history);
    const answer = await gradioCall(text, tuples);
    hideTyping();

    addMessage("assistant", answer);
    history.push({role:"assistant", content:answer});
    saveHistory();

    setSmall("Hazır", true);
  }catch(err){
    hideTyping();
    addMessage("assistant", "⚠️ Bağlantı hatası: " + (err?.message || err));
    setSmall("Hata", false);
  }
}

function doClear(){
  history = [];
  localStorage.removeItem(LS_KEY);
  // chat alanını temizle, chips geri gelsin
  chatEl.innerHTML = "";
  chatEl.appendChild(chips);
  chips.style.display = "flex";
  setSmall("Temizlendi", true);
}

sendBtn.addEventListener("click", send);
clearBtn.addEventListener("click", doClear);

inputEl.addEventListener("keydown",(e)=>{
  if(e.key === "Enter" && !e.shiftKey){
    e.preventDefault();
    send();
  }
});

/* =========================
   Particles (ultra hafif)
========================= */
const c = document.getElementById("particles");
const ctx = c.getContext("2d");
let W,H,pts=[];
function resize(){
  W = c.width = window.innerWidth;
  H = c.height = window.innerHeight;
  const n = Math.min(120, Math.floor((W*H)/18000));
  pts = Array.from({length:n}, ()=>({
    x:Math.random()*W, y:Math.random()*H,
    vx:(Math.random()-.5)*0.25, vy:(Math.random()-.5)*0.25,
    r:Math.random()*2.2+0.6
  }));
}
window.addEventListener("resize", resize);
resize();

function tick(){
  ctx.clearRect(0,0,W,H);
  for(const p of pts){
    p.x += p.vx; p.y += p.vy;
    if(p.x<0||p.x>W) p.vx*=-1;
    if(p.y<0||p.y>H) p.vy*=-1;

    ctx.beginPath();
    ctx.arc(p.x,p.y,p.r,0,Math.PI*2);
    ctx.fillStyle = "rgba(234,240,255,.35)";
    ctx.fill();
  }
  requestAnimationFrame(tick);
}
tick();
</script>
</body>
</html>

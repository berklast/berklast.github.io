<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galaktik Savaş</title>
    <style>
        /* OPTİMİZE EDİLMİŞ STİLLER */
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Orbitron', sans-serif;
            background: #000;
            color: #0ff;
            text-shadow: 0 0 5px #0ff;
            touch-action: none;
        }
        #lobby-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(0, 20, 40, 0.9);
            padding: 30px;
            border: 2px solid #0ff;
            border-radius: 15px;
            box-shadow: 0 0 30px #0ff;
            z-index: 100;
        }
        #game-container {
            display: none;
        }
        canvas {
            display: block;
            margin: 0 auto;
            background: #000;
            image-rendering: optimizeSpeed;
        }
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #0ff;
            background: rgba(0, 0, 30, 0.5);
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
        }
        #countdown {
            font-size: 24px;
            margin: 10px 0;
            color: #ff0;
        }
        button {
            background: linear-gradient(to right, #0066ff, #00ccff);
            border: none;
            color: white;
            padding: 12px 24px;
            margin: 10px;
            border-radius: 25px;
            cursor: pointer;
            font-family: 'Orbitron';
            font-weight: bold;
            transition: all 0.3s;
        }
        button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px #0ff;
        }
        #market {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 50, 0.9);
            padding: 20px;
            border: 2px solid #0ff;
            border-radius: 15px;
            display: none;
            z-index: 200;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- LOBBY EKRANI -->
    <div id="lobby-screen">
        <h1>GALAKTİK SAVAŞ</h1>
        <div id="player-count">Hazır Oyuncu: 1</div>
        <div id="countdown">Başlıyor: 10</div>
        <button id="ready-btn">HAZIR</button>
    </div>

    <!-- OYUN ALANI -->
    <div id="game-container">
        <canvas id="game-canvas" width="1000" height="700"></canvas>
        <div id="ui">
            <div>Bölüm: <span id="level">1</span>/150</div>
            <div>Sağlık: <span id="health">100</span></div>
            <div>Gold: <span id="gold">0</span></div>
            <div>Mermi: <span id="ammo">30</span></div>
            <div>Güç: <span id="power">10</span></div>
        </div>
    </div>

    <!-- MARKET -->
    <div id="market">
        <h2>MARKET</h2>
        <div class="item" onclick="buyUpgrade('health')">+50 Sağlık (100 Gold)</div>
        <div class="item" onclick="buyUpgrade('damage')">+5 Hasar (150 Gold)</div>
        <div class="item" onclick="buyUpgrade('ammo')">+30 Mermi (80 Gold)</div>
        <button onclick="closeMarket()">Kapat</button>
    </div>

    <script type="module">
        // FIREBASE KONFİG (KENDİ BİLGİLERİNİZLE DEĞİŞTİRİN)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD9DCF-8mJz-0NfBXnrYHfBawP1hNuXgKI",
            authDomain: "space-battle-game-291c7.firebaseapp.com",
            databaseURL: "https://space-battle-game-291c7-default-rtdb.firebaseio.com",
            projectId: "space-battle-game-291c7",
            storageBucket: "space-battle-game-291c7.appspot.com",
            messagingSenderId: "973408760674",
            appId: "1:973408760674:web:461f84c97f9b8a2793f23b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // OYUN SABİTLERİ
        const PLAYER_SPEED = 8;
        const BULLET_SPEED = 12;
        const ENEMY_BULLET_SPEED = 6;
        const LEVEL_COUNT = 150;
        const BOSS_INTERVAL = 10;
        const MARKET_INTERVAL = 20;

        // OYUN DEĞİŞKENLERİ
        const canvas = document.getElementById("game-canvas");
        const ctx = canvas.getContext("2d", { alpha: false });
        let gameState = {
            players: {},
            enemies: [],
            bullets: [],
            enemyBullets: [],
            particles: [],
            level: 1,
            countdown: 10,
            gameStarted: false,
            lastFrameTime: 0,
            playerId: `player_${Math.random().toString(36).substr(2, 9)}`,
            playerName: "",
            playerX: canvas.width / 2,
            playerY: canvas.height - 100,
            health: 100,
            maxHealth: 100,
            gold: 0,
            ammo: 30,
            damage: 10,
            isReady: false,
            isSpectator: false,
            boss: null,
            keys: {},
            lastShot: 0,
            marketOpen: false
        };

        // ASSET'LER
        const assets = {
            playerShip: generateShipSVG("#00ffff"),
            enemyShip: generateShipSVG("#ff0000"),
            bossShip: generateBossSVG(),
            explosion: generateExplosionSVG()
        };

        // OYUNU BAŞLAT
        initGame();

        function initGame() {
            // EVENT LISTENERS
            document.getElementById("ready-btn").addEventListener("click", toggleReady);
            document.addEventListener("keydown", (e) => gameState.keys[e.key] = true);
            document.addEventListener("keyup", (e) => gameState.keys[e.key] = false);

            // FIREBASE LİSTENERS
            onValue(ref(db, 'players'), (snapshot) => {
                gameState.players = snapshot.val() || {};
                updatePlayerCount();
                
                // 2+ oyuncu hazırsa geri sayım başlat
                const readyPlayers = Object.values(gameState.players).filter(p => p.isReady);
                if (readyPlayers.length >= 1 && !gameState.gameStarted) {
                    startCountdown();
                }
            });

            // OYUN DÖNGÜSÜ
            function gameLoop(timestamp) {
                const deltaTime = timestamp - gameState.lastFrameTime;
                gameState.lastFrameTime = timestamp;

                // Temizle
                ctx.fillStyle = "#000";
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Yıldızları çiz
                drawStars();

                // Oyun başladıysa ve izleyici değilse güncelle
                if (gameState.gameStarted && !gameState.isSpectator) {
                    updatePlayerPosition();
                    updateGame(deltaTime);
                }

                // Her durumda renderla
                renderGame();

                requestAnimationFrame(gameLoop);
            }

            requestAnimationFrame(gameLoop);
        }

        // OYUNCU HAZIRLIK DURUMU
        function toggleReady() {
            gameState.isReady = !gameState.isReady;
            const name = prompt("Pilot adınız:", `Pilot_${Math.floor(Math.random() * 1000)}`);
            gameState.playerName = name || "Anonim";
            
            update(ref(db, `players/${gameState.playerId}`), {
                id: gameState.playerId,
                name: gameState.playerName,
                x: gameState.playerX,
                y: gameState.playerY,
                health: gameState.health,
                gold: gameState.gold,
                ammo: gameState.ammo,
                isReady: gameState.isReady,
                isSpectator: false,
                lastActive: Date.now()
            });
        }

        // GERİ SAYIM
        function startCountdown() {
            const countdownInterval = setInterval(() => {
                gameState.countdown--;
                document.getElementById("countdown").textContent = `Başlıyor: ${gameState.countdown}`;
                
                if (gameState.countdown <= 0) {
                    clearInterval(countdownInterval);
                    startGame();
                }
            }, 1000);
        }

        // OYUNU BAŞLAT
        function startGame() {
            document.getElementById("lobby-screen").style.display = "none";
            document.getElementById("game-container").style.display = "block";
            gameState.gameStarted = true;
            
            // Oyuncu sayısına göre düşman üret
            spawnEnemies();
        }

        // OYUNCU POZİSYON GÜNCELLEME
        function updatePlayerPosition() {
            if (gameState.keys["ArrowLeft"]) gameState.playerX = Math.max(30, gameState.playerX - PLAYER_SPEED);
            if (gameState.keys["ArrowRight"]) gameState.playerX = Math.min(canvas.width - 30, gameState.playerX + PLAYER_SPEED);
            if (gameState.keys["ArrowUp"]) gameState.playerY = Math.max(30, gameState.playerY - PLAYER_SPEED);
            if (gameState.keys["ArrowDown"]) gameState.playerY = Math.min(canvas.height - 30, gameState.playerY + PLAYER_SPEED);
            
            // Ateş etme (Space)
            if (gameState.keys[" "] && Date.now() - gameState.lastShot > 200 && gameState.ammo > 0) {
                gameState.bullets.push({
                    x: gameState.playerX,
                    y: gameState.playerY - 30,
                    speed: BULLET_SPEED,
                    damage: gameState.damage
                });
                gameState.lastShot = Date.now();
                gameState.ammo--;
                updateAmmoUI();
            }

            // Firebase'e güncelle
            update(ref(db, `players/${gameState.playerId}`), {
                x: gameState.playerX,
                y: gameState.playerY,
                health: gameState.health,
                gold: gameState.gold,
                ammo: gameState.ammo,
                lastActive: Date.now()
            });
        }

        // OYUN GÜNCELLEMELERİ
        function updateGame(deltaTime) {
            // Mermileri güncelle
            updateBullets();
            
            // Düşmanları güncelle
            updateEnemies();
            
            // Çarpışmaları kontrol et
            checkCollisions();
            
            // Partikülleri güncelle
            updateParticles();
            
            // UI güncelleme
            updateUI();
            
            // Bölüm kontrolü
            checkLevelCompletion();
        }

        // OYUN RENDER
        function renderGame() {
            // Oyuncuları çiz
            renderPlayers();
            
            // Düşmanları çiz
            renderEnemies();
            
            // Mermileri çiz
            renderBullets();
            
            // Partikülleri çiz
            renderParticles();
            
            // Boss çiz
            if (gameState.boss) renderBoss();
        }

        // DİĞER FONKSİYONLAR...
        function generateShipSVG(color) {
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                <path d="M50 10 L90 50 L70 90 L30 90 L10 50 Z" fill="${color}"/>
                <circle cx="50" cy="30" r="10" fill="#ffff00"/>
            </svg>`;
            return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
        }

        function generateBossSVG() {
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200">
                <rect x="50" y="20" width="100" height="160" fill="#aa0000"/>
                <rect x="20" y="80" width="30" height="40" fill="#880000"/>
                <rect x="150" y="80" width="30" height="40" fill="#880000"/>
                <circle cx="100" cy="50" r="20" fill="#ff0000"/>
            </svg>`;
            return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
        }

        function drawStars() {
            ctx.fillStyle = "white";
            for (let i = 0; i < 200; i++) {
                const x = Math.random() * canvas.width;
                const y = (Math.random() * canvas.height + Date.now()/50) % canvas.height;
                const size = Math.random() * 2;
                ctx.fillRect(x, y, size, size);
            }
        }

        // [Diğer fonksiyonlar buraya eklenecek...]

        // MARKET İŞLEVLERİ
        function openMarket() {
            gameState.marketOpen = true;
            document.getElementById("market").style.display = "block";
        }

        function closeMarket() {
            gameState.marketOpen = false;
            document.getElementById("market").style.display = "none";
        }

        function buyUpgrade(type) {
            let cost = 0;
            switch(type) {
                case 'health':
                    cost = 100;
                    if (gameState.gold >= cost) {
                        gameState.gold -= cost;
                        gameState.maxHealth += 50;
                        gameState.health += 50;
                    }
                    break;
                case 'damage':
                    cost = 150;
                    if (gameState.gold >= cost) {
                        gameState.gold -= cost;
                        gameState.damage += 5;
                    }
                    break;
                case 'ammo':
                    cost = 80;
                    if (gameState.gold >= cost) {
                        gameState.gold -= cost;
                        gameState.ammo += 30;
                    }
                    break;
            }
            updateUI();
        }

        // UI GÜNCELLEME
        function updateUI() {
            document.getElementById("level").textContent = gameState.level;
            document.getElementById("health").textContent = gameState.health;
            document.getElementById("gold").textContent = gameState.gold;
            document.getElementById("ammo").textContent = gameState.ammo;
            document.getElementById("power").textContent = gameState.damage;
        }

        function updateAmmoUI() {
            document.getElementById("ammo").textContent = gameState.ammo;
        }

        function updatePlayerCount() {
            document.getElementById("player-count").textContent = 
                `Hazır Oyuncu: ${Object.keys(gameState.players).length}`;
        }
    </script>
</body>
</html>

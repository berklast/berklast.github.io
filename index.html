<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galaktik Savaş</title>
    <style>
        /* OPTIMIZED STYLES */
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Orbitron', sans-serif;
            background: #000;
            color: #0ff;
            text-shadow: 0 0 5px #0ff;
            touch-action: none;
        }
        #lobby-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(0, 20, 40, 0.9);
            padding: 30px;
            border: 2px solid #0ff;
            border-radius: 15px;
            box-shadow: 0 0 30px #0ff;
            z-index: 100;
        }
        #game-container {
            display: none;
        }
        canvas {
            display: block;
            margin: 0 auto;
            background: #000;
            image-rendering: optimizeSpeed;
        }
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #0ff;
            background: rgba(0, 0, 30, 0.5);
            padding: 10px;
            border-radius: 5px;
        }
        #countdown {
            font-size: 24px;
            margin: 10px 0;
        }
        button {
            background: linear-gradient(to right, #0066ff, #00ccff);
            border: none;
            color: white;
            padding: 12px 24px;
            margin: 10px;
            border-radius: 25px;
            cursor: pointer;
            font-family: 'Orbitron';
            font-weight: bold;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <div id="lobby-screen">
        <h1>GALAKTİK SAVAŞ</h1>
        <div id="player-count">Hazır Oyuncu: 1</div>
        <div id="countdown">Başlıyor: 10</div>
        <button id="ready-btn">HAZIR</button>
    </div>

    <div id="game-container">
        <canvas id="game-canvas" width="1000" height="700"></canvas>
        <div id="ui">
            <div>Bölüm: <span id="level">1</span>/150</div>
            <div>Sağlık: <span id="health">100</span></div>
            <div>Gold: <span id="gold">0</span></div>
            <div>Mermi: <span id="ammo">30</span></div>
        </div>
    </div>

    <script type="module">
        // FIREBASE CONFIG (USE YOUR OWN)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD9DCF-8mJz-0NfBXnrYHfBawP1hNuXgKI",
            authDomain: "space-battle-game-291c7.firebaseapp.com",
            databaseURL: "https://space-battle-game-291c7-default-rtdb.firebaseio.com",
            projectId: "space-battle-game-291c7",
            storageBucket: "space-battle-game-291c7.appspot.com",
            messagingSenderId: "973408760674",
            appId: "1:973408760674:web:461f84c97f9b8a2793f23b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // GAME CONSTANTS
        const PLAYER_SPEED = 8;
        const BULLET_SPEED = 12;
        const ENEMY_BULLET_SPEED = 6;
        const LEVEL_COUNT = 150;
        const BOSS_INTERVAL = 10;
        const MARKET_INTERVAL = 20;

        // GAME STATE
        const canvas = document.getElementById("game-canvas");
        const ctx = canvas.getContext("2d", { alpha: false });
        let gameState = {
            players: {},
            enemies: [],
            bullets: [],
            enemyBullets: [],
            particles: [],
            level: 1,
            countdown: 10,
            gameStarted: false,
            lastFrameTime: 0,
            playerId: `player_${Math.random().toString(36).substr(2, 9)}`,
            playerName: "",
            health: 100,
            maxHealth: 100,
            gold: 0,
            ammo: 30,
            damage: 10,
            isReady: false,
            isSpectator: false,
            boss: null
        };

        // ASSETS
        const assets = {
            playerShip: generateShipSVG("#00ffff"),
            enemyShip: generateShipSVG("#ff0000"),
            bossShip: generateBossSVG()
        };

        // INITIALIZE
        initGame();

        function initGame() {
            // EVENT LISTENERS
            document.getElementById("ready-btn").addEventListener("click", toggleReady);
            document.addEventListener("keydown", handleInput);

            // FIREBASE LISTENERS
            onValue(ref(db, 'players'), (snapshot) => {
                gameState.players = snapshot.val() || {};
                updatePlayerCount();
                
                // Start game when 2+ players are ready
                const readyPlayers = Object.values(gameState.players).filter(p => p.isReady);
                if (readyPlayers.length >= 1 && !gameState.gameStarted) {
                    startCountdown();
                }
            });

            // GAME LOOP
            function gameLoop(timestamp) {
                const deltaTime = timestamp - gameState.lastFrameTime;
                gameState.lastFrameTime = timestamp;

                // Clear canvas
                ctx.fillStyle = "#000";
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // Draw stars
                drawStars();

                // Only update if game is running
                if (gameState.gameStarted && !gameState.isSpectator) {
                    updateGame(deltaTime);
                }

                // Always render
                renderGame();

                requestAnimationFrame(gameLoop);
            }

            requestAnimationFrame(gameLoop);
        }

        // GAME FUNCTIONS
        function toggleReady() {
            gameState.isReady = !gameState.isReady;
            const name = prompt("Pilot adınız:", `Pilot_${Math.floor(Math.random() * 1000)}`);
            gameState.playerName = name || "Anonim";
            
            update(ref(db, `players/${gameState.playerId}`), {
                id: gameState.playerId,
                name: gameState.playerName,
                x: Math.floor(canvas.width / 2),
                y: canvas.height - 100,
                health: gameState.health,
                gold: gameState.gold,
                ammo: gameState.ammo,
                isReady: gameState.isReady,
                isSpectator: false,
                lastActive: Date.now()
            });
        }

        function startCountdown() {
            const countdownInterval = setInterval(() => {
                gameState.countdown--;
                document.getElementById("countdown").textContent = `Başlıyor: ${gameState.countdown}`;
                
                if (gameState.countdown <= 0) {
                    clearInterval(countdownInterval);
                    startGame();
                }
            }, 1000);
        }

        function startGame() {
            document.getElementById("lobby-screen").style.display = "none";
            document.getElementById("game-container").style.display = "block";
            gameState.gameStarted = true;
            
            // Spawn initial enemies based on player count
            spawnEnemies();
        }

        function updateGame(deltaTime) {
            // Update player position in Firebase
            update(ref(db, `players/${gameState.playerId}`), {
                x: gameState.playerX,
                y: gameState.playerY,
                health: gameState.health,
                gold: gameState.gold,
                ammo: gameState.ammo,
                lastActive: Date.now()
            });

            // Game logic continues...
            // [Previous game logic would go here]
        }

        // HELPER FUNCTIONS
        function generateShipSVG(color) {
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                <path d="M50 10 L90 50 L70 90 L30 90 L10 50 Z" fill="${color}"/>
                <circle cx="50" cy="30" r="10" fill="#ffff00"/>
            </svg>`;
            return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
        }

        function generateBossSVG() {
            // [Boss SVG generation code]
        }

        function drawStars() {
            // [Star drawing code]
        }

        // [Rest of the game functions...]
    </script>
</body>
</html>

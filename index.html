<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Galaktik Savaş</title>
    <style>
        /* ANA STİLLER */
        body {
            margin: 0;
            overflow: hidden;
            font-family: 'Orbitron', sans-serif;
            background: #000;
            color: #0ff;
            text-shadow: 0 0 5px #0ff;
            touch-action: none;
            height: 100vh;
        }

        /* MENÜ ARKAPLAN ANİMASYONU */
        #menu-bg {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            background: radial-gradient(ellipse at center, #000000 0%, #000033 100%);
        }
        .flying-ship {
            position: absolute;
            width: 150px;
            height: 50px;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 150 50"><path d="M10 25 L40 5 L140 25 L40 45 Z" fill="%2300ffff"/></svg>') no-repeat;
            animation: fly 15s linear infinite;
            opacity: 0.6;
            filter: drop-shadow(0 0 5px #00ffff);
        }
        .star {
            position: absolute;
            background: white;
            border-radius: 50%;
            animation: twinkle 5s infinite alternate;
        }
        @keyframes fly {
            0% { transform: translateX(-200px) translateY(100px); }
            100% { transform: translateX(calc(100vw + 200px)) translateY(-100px); }
        }
        @keyframes twinkle {
            0% { opacity: 0.3; }
            100% { opacity: 1; }
        }

        /* MENÜ EKRANI */
        #menu-screen {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            background: rgba(0, 20, 40, 0.9);
            padding: 30px;
            border: 2px solid #0ff;
            border-radius: 15px;
            box-shadow: 0 0 30px #0ff;
            width: 80%;
            max-width: 500px;
        }
        #menu-screen h1 {
            margin-top: 0;
            font-size: 2.5rem;
            color: #ff0;
            text-shadow: 0 0 10px #ff0;
        }
        #name-input {
            display: none;
            margin: 20px 0;
        }
        #ready-screen {
            display: none;
        }
        input {
            background: rgba(0, 0, 30, 0.7);
            color: #0ff;
            border: 1px solid #0ff;
            padding: 12px;
            margin: 10px 0;
            width: 80%;
            font-family: 'Orbitron';
            text-align: center;
            border-radius: 25px;
        }
        button {
            background: linear-gradient(to right, #0066ff, #00ccff);
            border: none;
            color: white;
            padding: 12px 24px;
            margin: 10px;
            border-radius: 25px;
            cursor: pointer;
            font-family: 'Orbitron';
            font-weight: bold;
            transition: all 0.3s;
            width: 80%;
        }
        button:hover {
            transform: scale(1.05);
            box-shadow: 0 0 15px #0ff;
        }

        /* OYUN EKRANI */
        #game-container {
            display: none;
            position: relative;
            width: 100%;
            height: 100%;
        }
        canvas {
            display: block;
            margin: 0 auto;
            background: #000;
            image-rendering: optimizeSpeed;
        }
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            color: #0ff;
            background: rgba(0, 0, 30, 0.5);
            padding: 10px;
            border-radius: 5px;
            font-size: 14px;
            border: 1px solid #0ff;
        }
        #countdown {
            font-size: 2rem;
            color: #ff0;
            text-align: center;
            margin: 20px 0;
        }
        #spectator-mode {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(0, 0, 0, 0.7);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            display: none;
            z-index: 100;
        }
    </style>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700&display=swap" rel="stylesheet">
</head>
<body>
    <!-- MENÜ ARKAPLANI -->
    <div id="menu-bg"></div>

    <!-- MENÜ EKRANI -->
    <div id="menu-screen">
        <h1>GALAKTİK SAVAŞ</h1>
        <div id="main-menu">
            <button id="play-btn">OYNA</button>
        </div>
        
        <div id="name-input">
            <input type="text" id="player-name" placeholder="Pilot Adı (En az 3 karakter)" minlength="3" required>
            <button id="confirm-name">ONAYLA</button>
        </div>
        
        <div id="ready-screen">
            <div id="countdown">10</div>
            <div id="players-waiting">Hazır oyuncu: 1</div>
            <button id="ready-btn">HAZIR</button>
        </div>
    </div>

    <!-- OYUN ALANI -->
    <div id="game-container">
        <canvas id="game-canvas" width="1000" height="700"></canvas>
        <div id="ui">
            <div>Bölüm: <span id="level">1</span>/150</div>
            <div>Sağlık: <span id="health">100</span></div>
            <div>Gold: <span id="gold">0</span></div>
            <div>Mermi: <span id="ammo">30</span></div>
        </div>
        <div id="spectator-mode">
            <h2>İZLEME MODUNDASINIZ</h2>
            <p>Bölüm geçilirse yeniden doğacaksınız</p>
        </div>
    </div>

    <script type="module">
        // FIREBASE KONFİG
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyD9DCF-8mJz-0NfBXnrYHfBawP1hNuXgKI",
            authDomain: "space-battle-game-291c7.firebaseapp.com",
            databaseURL: "https://space-battle-game-291c7-default-rtdb.firebaseio.com",
            projectId: "space-battle-game-291c7",
            storageBucket: "space-battle-game-291c7.appspot.com",
            messagingSenderId: "973408760674",
            appId: "1:973408760674:web:461f84c97f9b8a2793f23b"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // OYUN SABİTLERİ
        const PLAYER_SPEED = 8;
        const BULLET_SPEED = 12;
        const ENEMY_BULLET_SPEED = 6;
        const LEVEL_COUNT = 150;
        const BOSS_INTERVAL = 25; // Her 25 bölümde bir boss
        const ENEMY_INCREASE_INTERVAL = 2; // Her 2 bölümde 1 düşman artışı

        // OYUN DEĞİŞKENLERİ
        const canvas = document.getElementById("game-canvas");
        const ctx = canvas.getContext("2d", { alpha: false });
        let gameState = {
            players: {},
            playerId: `player_${Math.random().toString(36).substr(2, 9)}`,
            playerName: "",
            playerX: canvas.width / 2,
            playerY: canvas.height - 100,
            health: 100,
            maxHealth: 100,
            gold: 0,
            ammo: 30,
            damage: 10,
            isReady: false,
            gameStarted: false,
            countdown: 10,
            lastFrameTime: 0,
            keys: {},
            lastShot: 0,
            enemies: [],
            bullets: [],
            enemyBullets: [],
            particles: [],
            level: 1,
            boss: null,
            baseEnemies: 1, // Başlangıç düşman sayısı
            isSpectator: false,
            countdownInterval: null
        };

        // ASSET'LER
        const assets = {
            playerShip: generateShipSVG("#00ffff"),
            enemyShip: generateShipSVG("#ff0000"),
            bossShip: generateBossSVG(),
            explosion: generateExplosionSVG()
        };

        // MENÜ ELEMANLARI
        const menuElements = {
            mainMenu: document.getElementById("main-menu"),
            nameInput: document.getElementById("name-input"),
            readyScreen: document.getElementById("ready-screen"),
            playBtn: document.getElementById("play-btn"),
            confirmNameBtn: document.getElementById("confirm-name"),
            readyBtn: document.getElementById("ready-btn"),
            countdownDisplay: document.getElementById("countdown"),
            playersWaiting: document.getElementById("players-waiting"),
            spectatorMode: document.getElementById("spectator-mode")
        };

        // OYUNU BAŞLAT
        initGame();

        function initGame() {
            // MENÜ ARKAPLANINI AYARLA
            createFlyingShips();
            createStars();
            
            // EVENT LİSTENERS
            menuElements.playBtn.addEventListener("click", showNameInput);
            menuElements.confirmNameBtn.addEventListener("click", confirmName);
            menuElements.readyBtn.addEventListener("click", toggleReady);
            
            document.addEventListener("keydown", (e) => {
                gameState.keys[e.key] = true;
                if (e.key === "Enter" && menuElements.nameInput.style.display === "block") {
                    confirmName();
                }
            });
            document.addEventListener("keyup", (e) => gameState.keys[e.key] = false);

            // FIREBASE LİSTENERS
            onValue(ref(db, 'players'), (snapshot) => {
                gameState.players = snapshot.val() || {};
                updatePlayerCount();
                
                // Oyun başlatma kontrolü
                const readyPlayers = Object.values(gameState.players).filter(p => p.isReady);
                if (readyPlayers.length >= 1 && !gameState.gameStarted) {
                    startCountdown();
                } else if (readyPlayers.length === 0 && gameState.countdownInterval) {
                    stopCountdown();
                }
                
                // Eğer izleyici modundaysak ve başka oyuncu kalmadıysa lobiye dön
                if (gameState.isSpectator && Object.keys(gameState.players).filter(p => p.isAlive).length === 0) {
                    returnToLobby();
                }
            });

            // OYUN DÖNGÜSÜ
            function gameLoop(timestamp) {
                const deltaTime = timestamp - gameState.lastFrameTime;
                gameState.lastFrameTime = timestamp;

                if (gameState.gameStarted) {
                    // Oyun güncellemeleri
                    updateGame(deltaTime);
                }

                // Render
                renderGame();
                requestAnimationFrame(gameLoop);
            }
            requestAnimationFrame(gameLoop);
        }

        // MENÜ FONKSİYONLARI
        function showNameInput() {
            menuElements.mainMenu.style.display = "none";
            menuElements.nameInput.style.display = "block";
            document.getElementById("player-name").focus();
        }

        function confirmName() {
            const name = document.getElementById("player-name").value.trim();
            if (name.length < 3) {
                alert("En az 3 karakter girin!");
                return;
            }
            
            gameState.playerName = name;
            menuElements.nameInput.style.display = "none";
            menuElements.readyScreen.style.display = "block";
            updatePlayerCount();
        }

        function toggleReady() {
            gameState.isReady = !gameState.isReady;
            
            if (gameState.isReady) {
                menuElements.readyBtn.textContent = "HAZIR (" + gameState.playerName + ")";
                menuElements.readyBtn.style.background = "linear-gradient(to right, #00cc00, #00ff00)";
                
                // Firebase'e oyuncu ekle
                const playerRef = ref(db, `players/${gameState.playerId}`);
                set(playerRef, {
                    id: gameState.playerId,
                    name: gameState.playerName,
                    isReady: true,
                    isAlive: true,
                    lastActive: Date.now(),
                    x: gameState.playerX,
                    y: gameState.playerY,
                    health: gameState.health,
                    gold: gameState.gold,
                    ammo: gameState.ammo
                });
                
                // Bağlantı kesilirse oyuncuyu kaldır
                onDisconnect(playerRef).remove();
            } else {
                menuElements.readyBtn.textContent = "HAZIR";
                menuElements.readyBtn.style.background = "linear-gradient(to right, #0066ff, #00ccff)";
                remove(ref(db, `players/${gameState.playerId}`));
            }
        }

        function updatePlayerCount() {
            const playerCount = Object.keys(gameState.players).length;
            menuElements.playersWaiting.textContent = `Hazır oyuncu: ${playerCount}`;
        }

        function startCountdown() {
            // Önceki sayacı temizle
            if (gameState.countdownInterval) {
                clearInterval(gameState.countdownInterval);
            }
            
            gameState.countdown = 10;
            menuElements.countdownDisplay.textContent = gameState.countdown;
            gameState.countdownInterval = setInterval(() => {
                gameState.countdown--;
                menuElements.countdownDisplay.textContent = gameState.countdown;
                
                if (gameState.countdown <= 0) {
                    stopCountdown();
                    startGame();
                }
            }, 1000);
        }

        function stopCountdown() {
            if (gameState.countdownInterval) {
                clearInterval(gameState.countdownInterval);
                gameState.countdownInterval = null;
            }
            menuElements.countdownDisplay.textContent = "10";
        }

        function startGame() {
            gameState.gameStarted = true;
            gameState.isSpectator = false;
            document.getElementById("menu-screen").style.display = "none";
            document.getElementById("game-container").style.display = "block";
            menuElements.spectatorMode.style.display = "none";
            
            // Oyun başlangıç ayarları
            gameState.level = 1;
            gameState.baseEnemies = 1;
            gameState.health = 100;
            gameState.gold = 0;
            gameState.ammo = 30;
            updateUI();
            spawnEnemies();
        }

        // OYUN FONKSİYONLARI
        function updateGame(deltaTime) {
            // Oyuncu pozisyon güncelleme
            if (!gameState.isSpectator) {
                updatePlayerPosition();
            }
            
            // Mermileri güncelle
            updateBullets();
            
            // Düşmanları güncelle
            updateEnemies();
            
            // Boss güncelle
            if (gameState.boss) updateBoss();
            
            // Çarpışma kontrolü
            checkCollisions();
            
            // UI güncelleme
            updateUI();
            
            // Bölüm kontrolü
            checkLevelCompletion();
            
            // Oyuncu ölüm kontrolü
            if (gameState.health <= 0 && !gameState.isSpectator) {
                enterSpectatorMode();
            }
        }

        function renderGame() {
            // Temizle
            ctx.fillStyle = "#000";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // Yıldızları çiz
            drawStars();
            
            // Oyuncuları çiz
            renderPlayers();
            
            // Düşmanları çiz
            renderEnemies();
            
            // Mermileri çiz
            renderBullets();
            
            // Boss çiz
            if (gameState.boss) renderBoss();
        }

        function updatePlayerPosition() {
            if (gameState.keys["ArrowLeft"]) gameState.playerX = Math.max(30, gameState.playerX - PLAYER_SPEED);
            if (gameState.keys["ArrowRight"]) gameState.playerX = Math.min(canvas.width - 30, gameState.playerX + PLAYER_SPEED);
            if (gameState.keys["ArrowUp"]) gameState.playerY = Math.max(30, gameState.playerY - PLAYER_SPEED);
            if (gameState.keys["ArrowDown"]) gameState.playerY = Math.min(canvas.height - 30, gameState.playerY + PLAYER_SPEED);
            
            // Ateş etme (Space)
            if (gameState.keys[" "] && Date.now() - gameState.lastShot > 200 && gameState.ammo > 0) {
                gameState.bullets.push({
                    x: gameState.playerX,
                    y: gameState.playerY - 30,
                    speed: BULLET_SPEED,
                    damage: gameState.damage,
                    isPlayer: true
                });
                gameState.lastShot = Date.now();
                gameState.ammo--;
                updateAmmoUI();
            }

            // Firebase'e güncelle
            update(ref(db, `players/${gameState.playerId}`), {
                x: gameState.playerX,
                y: gameState.playerY,
                health: gameState.health,
                gold: gameState.gold,
                ammo: gameState.ammo,
                isAlive: gameState.health > 0,
                lastActive: Date.now()
            });
        }

        function spawnEnemies() {
            gameState.enemies = [];
            
            // Her 2 bölümde 1 düşman artışı
            const enemyCount = gameState.baseEnemies + Math.floor(gameState.level / ENEMY_INCREASE_INTERVAL);
            
            for (let i = 0; i < enemyCount; i++) {
                gameState.enemies.push({
                    x: Math.random() * (canvas.width - 100) + 50,
                    y: 50 + Math.random() * 50, // Üst kısımda rastgele konum
                    speed: 2 + Math.random() * 2,
                    health: 30,
                    lastShot: 0,
                    movePattern: Math.floor(Math.random() * 3) // 0: sabit, 1: yatay hareket, 2: zigzag
                });
            }
            
            // Boss kontrolü
            if (gameState.level % BOSS_INTERVAL === 0) {
                spawnBoss();
            }
            
            document.getElementById("enemies").textContent = gameState.enemies.length + (gameState.boss ? 1 : 0);
        }

        function spawnBoss() {
            gameState.boss = {
                x: canvas.width / 2,
                y: 150,
                width: 200,
                height: 100,
                health: 50, // 50 mermi vurunca ölecek
                speed: 1,
                lastAttack: 0,
                moveDirection: 1
            };
        }

        function updateBoss() {
            const boss = gameState.boss;
            
            // Boss hareketi
            boss.x += boss.speed * boss.moveDirection;
            if (boss.x > canvas.width - boss.width/2 || boss.x < boss.width/2) {
                boss.moveDirection *= -1;
            }
            
            // Boss ateş etme
            if (Date.now() - boss.lastAttack > 1000) {
                // Oyuncuya doğru ateş et
                const angle = Math.atan2(
                    gameState.playerY - boss.y,
                    gameState.playerX - boss.x
                );
                
                gameState.enemyBullets.push({
                    x: boss.x,
                    y: boss.y + boss.height/2,
                    speedX: Math.cos(angle) * ENEMY_BULLET_SPEED,
                    speedY: Math.sin(angle) * ENEMY_BULLET_SPEED,
                    damage: 10,
                    isBoss: true
                });
                
                boss.lastAttack = Date.now();
            }
        }

        function updateBullets() {
            // Oyuncu mermileri
            for (let i = gameState.bullets.length - 1; i >= 0; i--) {
                gameState.bullets[i].y -= gameState.bullets[i].speed;
                
                // Ekran dışına çıkan mermileri sil
                if (gameState.bullets[i].y < 0) {
                    gameState.bullets.splice(i, 1);
                    continue;
                }
                
                // Düşmanlara çarpma kontrolü
                for (let j = gameState.enemies.length - 1; j >= 0; j--) {
                    if (checkCollision(gameState.bullets[i], gameState.enemies[j])) {
                        gameState.enemies[j].health -= gameState.bullets[i].damage;
                        gameState.bullets.splice(i, 1);
                        
                        if (gameState.enemies[j].health <= 0) {
                            gameState.gold += 20;
                            gameState.enemies.splice(j, 1);
                            document.getElementById("enemies").textContent = gameState.enemies.length + (gameState.boss ? 1 : 0);
                        }
                        break;
                    }
                }
                
                // Boss'a çarpma kontrolü
                if (gameState.boss && checkCollision(gameState.bullets[i], gameState.boss)) {
                    gameState.boss.health -= 1; // Her mermi 1 hasar
                    gameState.bullets.splice(i, 1);
                    
                    if (gameState.boss.health <= 0) {
                        gameState.gold += 100;
                        gameState.boss = null;
                        document.getElementById("enemies").textContent = gameState.enemies.length;
                    }
                }
            }
            
            // Düşman mermileri
            for (let i = gameState.enemyBullets.length - 1; i >= 0; i--) {
                const bullet = gameState.enemyBullets[i];
                
                if (bullet.isBoss) {
                    bullet.x += bullet.speedX;
                    bullet.y += bullet.speedY;
                } else {
                    bullet.y += bullet.speed;
                }
                
                // Ekran dışına çıkan mermileri sil
                if (bullet.y > canvas.height || bullet.x < 0 || bullet.x > canvas.width) {
                    gameState.enemyBullets.splice(i, 1);
                }
            }
        }

        function updateEnemies() {
            for (let i = gameState.enemies.length - 1; i >= 0; i--) {
                const enemy = gameState.enemies[i];
                
                // Hareket pattern'leri
                switch(enemy.movePattern) {
                    case 0: // Sabit
                        break;
                    case 1: // Yatay hareket
                        enemy.x += enemy.speed;
                        if (enemy.x > canvas.width - 50 || enemy.x < 50) {
                            enemy.speed *= -1;
                        }
                        break;
                    case 2: // Zigzag
                        enemy.x += enemy.speed;
                        if (enemy.x > canvas.width - 50 || enemy.x < 50) {
                            enemy.speed *= -1;
                        }
                        break;
                }
                
                // Oyuncuya doğru ateş et
                if (Date.now() - enemy.lastShot > 1500) {
                    const angle = Math.atan2(
                        gameState.playerY - enemy.y,
                        gameState.playerX - enemy.x
                    );
                    
                    gameState.enemyBullets.push({
                        x: enemy.x,
                        y: enemy.y + 20,
                        speedX: Math.cos(angle) * ENEMY_BULLET_SPEED,
                        speedY: Math.sin(angle) * ENEMY_BULLET_SPEED,
                        damage: 5
                    });
                    
                    enemy.lastShot = Date.now();
                }
            }
        }

        function checkCollisions() {
            // Düşman mermileri ile oyuncu
            if (!gameState.isSpectator) {
                for (let i = gameState.enemyBullets.length - 1; i >= 0; i--) {
                    if (checkCollision(gameState.enemyBullets[i], {
                        x: gameState.playerX,
                        y: gameState.playerY,
                        width: 30,
                        height: 30
                    })) {
                        gameState.health -= gameState.enemyBullets[i].damage;
                        gameState.enemyBullets.splice(i, 1);
                        update(ref(db, `players/${gameState.playerId}`), {
                            health: gameState.health,
                            isAlive: gameState.health > 0
                        });
                    }
                }
            }
        }

        function checkLevelCompletion() {
            if (gameState.enemies.length === 0 && !gameState.boss) {
                gameState.level++;
                
                // Eğer izleyici modundaysak ve bölüm geçildiyse yeniden doğ
                if (gameState.isSpectator) {
                    respawnPlayer();
                    return;
                }
                
                if (gameState.level > LEVEL_COUNT) {
                    endGame(true);
                    return;
                }
                
                spawnEnemies();
            }
        }

        function enterSpectatorMode() {
            gameState.isSpectator = true;
            menuElements.spectatorMode.style.display = "block";
            update(ref(db, `players/${gameState.playerId}`), {
                isAlive: false
            });
            
            // Tüm oyuncular öldüyse lobiye dön
            const alivePlayers = Object.values(gameState.players).filter(p => p.isAlive);
            if (alivePlayers.length === 0) {
                setTimeout(returnToLobby, 3000);
            }
        }

        function respawnPlayer() {
            gameState.isSpectator = false;
            gameState.health = 100;
            menuElements.spectatorMode.style.display = "none";
            update(ref(db, `players/${gameState.playerId}`), {
                health: 100,
                isAlive: true
            });
        }

        function returnToLobby() {
            resetGame();
            alert("Tüm oyuncular öldü! Lobiye dönülüyor.");
        }

        function renderPlayers() {
            const playerImg = new Image();
            playerImg.src = assets.playerShip;
            
            // Kendi gemimiz (eğer ölmediysek)
            if (!gameState.isSpectator) {
                ctx.drawImage(playerImg, gameState.playerX - 25, gameState.playerY - 25, 50, 50);
            }
            
            // Diğer oyuncular
            for (const playerId in gameState.players) {
                if (playerId !== gameState.playerId) {
                    const player = gameState.players[playerId];
                    if (player.isAlive) {
                        ctx.drawImage(playerImg, player.x - 25, player.y - 25, 50, 50);
                    }
                }
            }
        }

        function renderEnemies() {
            const enemyImg = new Image();
            enemyImg.src = assets.enemyShip;
            
            for (const enemy of gameState.enemies) {
                ctx.drawImage(enemyImg, enemy.x - 20, enemy.y - 20, 40, 40);
            }
        }

        function renderBoss() {
            const bossImg = new Image();
            bossImg.src = assets.bossShip;
            ctx.drawImage(bossImg, gameState.boss.x - gameState.boss.width/2, 
                         gameState.boss.y - gameState.boss.height/2, 
                         gameState.boss.width, gameState.boss.height);
            
            // Boss can bar
            ctx.fillStyle = "red";
            ctx.fillRect(gameState.boss.x - gameState.boss.width/2, 
                        gameState.boss.y - gameState.boss.height/2 - 20, 
                        gameState.boss.width, 5);
            
            ctx.fillStyle = "green";
            ctx.fillRect(gameState.boss.x - gameState.boss.width/2, 
                        gameState.boss.y - gameState.boss.height/2 - 20, 
                        gameState.boss.width * (gameState.boss.health / 50), 5);
        }

        function renderBullets() {
            // Oyuncu mermileri
            ctx.fillStyle = "#ffff00";
            for (const bullet of gameState.bullets) {
                ctx.fillRect(bullet.x - 2, bullet.y - 10, 4, 10);
            }
            
            // Düşman mermileri
            ctx.fillStyle = "#ff0000";
            for (const bullet of gameState.enemyBullets) {
                ctx.fillRect(bullet.x - 2, bullet.y, 4, 10);
            }
            
            // Boss mermileri
            ctx.fillStyle = "#ff00ff";
            for (const bullet of gameState.enemyBullets.filter(b => b.isBoss)) {
                ctx.beginPath();
                ctx.arc(bullet.x, bullet.y, 8, 0, Math.PI * 2);
                ctx.fill();
            }
        }

        function updateUI() {
            document.getElementById("level").textContent = gameState.level;
            document.getElementById("health").textContent = gameState.health;
            document.getElementById("gold").textContent = gameState.gold;
        }

        function updateAmmoUI() {
            document.getElementById("ammo").textContent = gameState.ammo;
        }

        // YARDIMCI FONKSİYONLAR
        function generateShipSVG(color) {
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                <path d="M50 10 L90 50 L70 90 L30 90 L10 50 Z" fill="${color}"/>
                <circle cx="50" cy="30" r="10" fill="#ffff00"/>
            </svg>`;
            return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
        }

        function generateBossSVG() {
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200">
                <rect x="50" y="20" width="100" height="160" fill="#aa0000"/>
                <rect x="20" y="80" width="30" height="40" fill="#880000"/>
                <rect x="150" y="80" width="30" height="40" fill="#880000"/>
                <circle cx="100" cy="50" r="20" fill="#ff0000"/>
                <circle cx="70" cy="150" r="15" fill="#ff0000"/>
                <circle cx="130" cy="150" r="15" fill="#ff0000"/>
            </svg>`;
            return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
        }

        function generateExplosionSVG() {
            const svg = `<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="40" fill="#ff9900"/>
                <path d="M30,30 L70,70 M70,30 L30,70 M50,10 L50,90 M10,50 L90,50" stroke="#ff0000" stroke-width="4"/>
            </svg>`;
            return `data:image/svg+xml;utf8,${encodeURIComponent(svg)}`;
        }

        function createFlyingShips() {
            const bg = document.getElementById("menu-bg");
            for (let i = 0; i < 5; i++) {
                const ship = document.createElement("div");
                ship.className = "flying-ship";
                ship.style.left = Math.random() * 100 + "vw";
                ship.style.top = Math.random() * 100 + "vh";
                ship.style.animationDuration = (10 + Math.random() * 20) + "s";
                ship.style.animationDelay = (Math.random() * 10) + "s";
                bg.appendChild(ship);
            }
        }

        function createStars() {
            const bg = document.getElementById("menu-bg");
            for (let i = 0; i < 100; i++) {
                const star = document.createElement("div");
                star.className = "star";
                star.style.width = (1 + Math.random() * 3) + "px";
                star.style.height = star.style.width;
                star.style.left = Math.random() * 100 + "vw";
                star.style.top = Math.random() * 100 + "vh";
                star.style.animationDelay = (Math.random() * 5) + "s";
                star.style.opacity = 0.3 + Math.random() * 0.7;
                bg.appendChild(star);
            }
        }

        function drawStars() {
            ctx.fillStyle = "white";
            for (let i = 0; i < 200; i++) {
                const x = Math.random() * canvas.width;
                const y = (Math.random() * canvas.height + Date.now()/50) % canvas.height;
                const size = Math.random() * 2;
                ctx.fillRect(x, y, size, size);
            }
        }

        function checkCollision(obj1, obj2) {
            return Math.abs(obj1.x - obj2.x) < 30 && Math.abs(obj1.y - obj2.y) < 30;
        }

        function endGame(win) {
            if (win) {
                alert("Tebrikler! Tüm bölümleri tamamladınız!");
            } else {
                alert("Oyun bitti! Yeniden deneyin.");
            }
            
            // Oyunu sıfırla
            resetGame();
        }

        function resetGame() {
            // Firebase'den oyuncuyu kaldır
            remove(ref(db, `players/${gameState.playerId}`));
            
            // Oyun durumunu sıfırla
            gameState.gameStarted = false;
            gameState.isSpectator = false;
            gameState.level = 1;
            gameState.baseEnemies = 1;
            gameState.health = 100;
            gameState.gold = 0;
            gameState.ammo = 30;
            gameState.enemies = [];
            gameState.boss = null;
            
            // Menüyü göster
            document.getElementById("menu-screen").style.display = "block";
            document.getElementById("game-container").style.display = "none";
            menuElements.mainMenu.style.display = "block";
            menuElements.nameInput.style.display = "none";
            menuElements.readyScreen.style.display = "none";
            menuElements.spectatorMode.style.display = "none";
        }
    </script>
</body>
</html>
